name: Auto Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build/release even without Python changes?'
        type: boolean
        required: true
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
        
    - name: Run tests
      run: |
        python -m pytest test_passwgen.py -v

  check-changes:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      python_changed: ${{ steps.set-outputs.outputs.python_changed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Build Need
        id: set-outputs
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Always build if manually forced
            echo "python_changed=${{ inputs.force_build || 'true' }}" >> $GITHUB_OUTPUT
          else
            # Check for Python changes in push events
            git diff --name-only ${{ github.event.before }} ${{ github.event.after }} > changes.txt
            changed=$(grep -q '\.py$' changes.txt && echo 'true' || echo 'false')
            echo "python_changed=$changed" >> $GITHUB_OUTPUT
          fi

  build-linux:
    needs: [test, check-changes]
    if: needs.check-changes.outputs.python_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build CLI
        run: pyinstaller --onefile src/passwgen.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-cli
          path: dist/passwgen

  build-linux-ui:
    needs: [test, check-changes]
    if: needs.check-changes.outputs.python_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build UI
        run: pyinstaller --onefile src/ui.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-ui
          path: dist/ui

  build-windows:
    needs: [test, check-changes]
    if: needs.check-changes.outputs.python_changed == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
  
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"
  
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
  
      - name: Build CLI (Directory Mode)
        run: pyinstaller src\passwgen.py
          
      - name: Package Output
        run: Compress-Archive -Path dist\passwgen -DestinationPath dist\passwgen.zip
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-cli
          path: dist/passwgen.zip
    
  build-windows-ui:
    needs: [test, check-changes]
    if: needs.check-changes.outputs.python_changed == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build UI
        run: pyinstaller --onefile src\ui.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-ui
          path: dist/ui.exe

  create-release:
    needs: [check-changes, build-linux, build-windows, build-linux-ui, build-windows-ui, test]
    if: needs.check-changes.outputs.python_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Determine Next Version and Get Commit Info
        id: versioning
        run: |
          git fetch --tags
          latest_tag=$(git tag -l "autobuild.*" | sort -V | tail -n 1 || echo "autobuild.0")
          latest_version=${latest_tag#autobuild.}
          next_version=$((latest_version + 1))
          
          # Get commit message for release name
          latest_commit_message=$(git log -1 --pretty=%s)
          echo "next_version=autobuild.${next_version}" >> $GITHUB_OUTPUT
          echo "latest_commit_message=${latest_commit_message}" >> $GITHUB_OUTPUT
          
          # Get commit history since last release
          if [ "$latest_tag" != "autobuild.0" ]; then
            commit_history=$(git log --pretty=format:"- %s (%h)" $latest_tag..HEAD)
          else
            commit_history=$(git log --pretty=format:"- %s (%h)")
          fi
          echo "COMMIT_HISTORY<<EOF" >> $GITHUB_ENV
          echo "$commit_history" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.versioning.outputs.next_version }}
          name: "${{ steps.versioning.outputs.latest_commit_message }}"
          body: |
            ### Changes since last release (${{ steps.versioning.outputs.previous_tag }})
            ${{ env.COMMIT_HISTORY }}

            ### Included in this release:
            - CLI application (Windows/Linux)
            - UI application (Windows/Linux)
          files: |
            artifacts/linux-cli/passwgen
            artifacts/windows-cli/passwgen.zip
            artifacts/linux-ui/ui
            artifacts/windows-ui/ui.exe
          draft: false
          prerelease: false